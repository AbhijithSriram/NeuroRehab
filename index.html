<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Ball Catching Game</title>
    <meta name="description" content="Neuro Rehab VR Ball Game">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/super-hands/3.0.3/super-hands.min.js"></script>
</head>
<body>
    <a-scene embedded style="height: 100vh; width: 100vw;" vr-mode-ui="enabled: true">
        <!-- Assets -->
        <a-assets>
            <a-mixin id="ball" 
                geometry="primitive: sphere; radius: 0.15" 
                material="color: #ff4444; roughness: 0.2; metalness: 0.1"
                shadow="cast: true; receive: true">
            </a-mixin>
        </a-assets>

        <!-- Environment -->
        <a-sky color="#87CEEB"></a-sky>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" 
                 color="#90EE90" shadow="receive: true"></a-plane>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light type="directional" position="2 4 2" color="#ffffff" intensity="0.8" shadow="cast: true"></a-light>

        <!-- Game UI -->
        <a-text id="score-text" position="-2 3 -3" value="Score: 0/10" color="black" 
                font="kelsonsans" width="8" align="center"></a-text>
        <a-text id="round-text" position="0 3.5 -3" value="Round 1" color="black" 
                font="kelsonsans" width="6" align="center"></a-text>
        <a-text id="instruction-text" position="0 2.5 -3" 
                value="Catch the balls with your controllers!" color="blue" 
                font="kelsonsans" width="4" align="center"></a-text>

        <!-- Ball spawn points (invisible) -->
        <a-entity id="left-spawn" position="-3 2 -2"></a-entity>
        <a-entity id="right-spawn" position="3 2 -2"></a-entity>
        <a-entity id="target-point" position="0 1.6 -0.5"></a-entity>

        <!-- VR Controllers -->
        <a-entity id="left-hand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
                  laser-controls raycaster="objects: .ball; far: 1" line="color: red; opacity: 0.75"
                  super-hands="colliderEvent: raycaster-intersection; colliderEndEvent: raycaster-intersection-cleared">
        </a-entity>
        
        <a-entity id="right-hand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc"
                  laser-controls raycaster="objects: .ball; far: 1" line="color: blue; opacity: 0.75"
                  super-hands="colliderEvent: raycaster-intersection; colliderEndEvent: raycaster-intersection-cleared">
        </a-entity>

        <!-- Camera rig -->
        <a-entity id="rig" movement-controls position="0 1.6 1">
            <a-camera id="camera" look-controls wasd-controls-enabled="false"></a-camera>
        </a-entity>

        <!-- Game Logic -->
        <a-entity id="game-controller"></a-entity>
    </a-scene>

    <script>
        // Game state
        let gameState = {
            score: 0,
            round: 1,
            ballsThrown: 0,
            totalBalls: 10,
            isGameActive: true,
            ballSpeed: 2
        };

        // Ball spawning and game logic
        AFRAME.registerComponent('game-controller', {
            init: function() {
                this.spawnBall = this.spawnBall.bind(this);
                this.resetRound = this.resetRound.bind(this);
                
                // Start the first ball after a delay
                setTimeout(() => {
                    this.spawnBall();
                }, 2000);
            },

            spawnBall: function() {
                if (!gameState.isGameActive || gameState.ballsThrown >= gameState.totalBalls) {
                    return;
                }

                // Randomly choose left or right spawn
                const isLeft = Math.random() < 0.5;
                const spawnPoint = isLeft ? 
                    document.querySelector('#left-spawn').object3D.position :
                    document.querySelector('#right-spawn').object3D.position;

                // Create ball entity
                const ball = document.createElement('a-sphere');
                ball.setAttribute('mixin', 'ball');
                ball.setAttribute('class', 'ball catchable');
                ball.setAttribute('position', `${spawnPoint.x} ${spawnPoint.y} ${spawnPoint.z}`);
                ball.setAttribute('dynamic-body', 'mass: 1');
                
                // Add unique ID
                ball.setAttribute('id', `ball-${Date.now()}`);

                // Add ball to scene
                document.querySelector('a-scene').appendChild(ball);

                // Animate ball movement
                const targetPos = document.querySelector('#target-point').object3D.position;
                const duration = 3000 / gameState.ballSpeed;
                
                ball.setAttribute('animation', {
                    property: 'position',
                    to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
                    dur: duration,
                    easing: 'linear'
                });

                // Add collision detection
                ball.addEventListener('collide', (evt) => {
                    if (evt.detail.target.classList.contains('controller')) {
                        this.catchBall(ball);
                    }
                });

                // Add controller intersection detection
                ball.addEventListener('raycaster-intersected', (evt) => {
                    this.catchBall(ball);
                });

                // Remove ball if it reaches the end without being caught
                setTimeout(() => {
                    if (ball.parentNode) {
                        ball.parentNode.removeChild(ball);
                        this.nextBall();
                    }
                }, duration + 500);

                gameState.ballsThrown++;
                this.updateUI();
            },

            catchBall: function(ball) {
                if (ball.parentNode) {
                    // Visual feedback
                    ball.setAttribute('material', 'color: #44ff44');
                    ball.setAttribute('animation', {
                        property: 'scale',
                        to: '0.1 0.1 0.1',
                        dur: 200
                    });
                    
                    // Remove ball and update score
                    setTimeout(() => {
                        if (ball.parentNode) {
                            ball.parentNode.removeChild(ball);
                        }
                    }, 200);
                    
                    gameState.score++;
                    this.updateUI();
                    this.nextBall();
                }
            },

            nextBall: function() {
                if (gameState.ballsThrown >= gameState.totalBalls) {
                    this.endRound();
                } else {
                    // Spawn next ball after delay
                    setTimeout(() => {
                        this.spawnBall();
                    }, 1500);
                }
            },

            endRound: function() {
                gameState.isGameActive = false;
                
                // Show round results
                const resultText = document.createElement('a-text');
                resultText.setAttribute('position', '0 2 -2');
                resultText.setAttribute('value', `Round ${gameState.round} Complete!\nScore: ${gameState.score}/${gameState.totalBalls}\n\nStarting next round...`);
                resultText.setAttribute('color', 'green');
                resultText.setAttribute('font', 'kelsonsans');
                resultText.setAttribute('width', '6');
                resultText.setAttribute('align', 'center');
                document.querySelector('a-scene').appendChild(resultText);

                // Start next round after delay
                setTimeout(() => {
                    document.querySelector('a-scene').removeChild(resultText);
                    this.resetRound();
                }, 3000);
            },

            resetRound: function() {
                gameState.round++;
                gameState.ballsThrown = 0;
                gameState.score = 0;
                gameState.isGameActive = true;
                gameState.ballSpeed = Math.min(gameState.ballSpeed + 0.2, 3); // Increase difficulty
                
                this.updateUI();
                
                // Start next round
                setTimeout(() => {
                    this.spawnBall();
                }, 1000);
            },

            updateUI: function() {
                document.querySelector('#score-text').setAttribute('value', `Score: ${gameState.score}/${gameState.totalBalls}`);
                document.querySelector('#round-text').setAttribute('value', `Round ${gameState.round}`);
            }
        });

        // Add game controller to the scene
        document.querySelector('#game-controller').setAttribute('game-controller', '');

        // Add some basic keyboard controls for testing without VR
        document.addEventListener('keydown', (evt) => {
            if (evt.key === ' ') {
                // Spacebar to simulate catch
                const balls = document.querySelectorAll('.ball');
                if (balls.length > 0) {
                    const gameController = document.querySelector('#game-controller').components['game-controller'];
                    gameController.catchBall(balls[0]);
                }
            }
        });
    </script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>

    <div class="instructions">
        <strong>VR Ball Catching Game</strong><br>
        • Put on VR headset and grab controllers<br>
        • Catch red balls coming from left/right<br>
        • Use controllers to intersect with balls<br>
        • 10 balls per round<br>
        • Press SPACEBAR to test catch (desktop only)
    </div>
</body>
</html>
